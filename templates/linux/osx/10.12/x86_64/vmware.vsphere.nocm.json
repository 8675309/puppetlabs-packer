{
  "variables": {
    "template_name"            : "osx-1012-x86_64",
    "beakerhost"               : "osx1012-64a",
    "version"                  : "0.0.2",

    "ssh_username"             : "osx",
    "ssh_password"             : "{{env `QA_ROOT_PASSWD`}}", 
    "install_xcode_cli_tools"  : "true",
    "update_system"            : "true",

    "project_root"             : "../../../../..",
    "headless"                 : "true",
    "template_config"          : "vsphere-nocm",
    "provisioner"              : "vmware",
    "shutdown_command"         : "echo 'osx' | sudo -S shutdown -h now",

    "qa_root_passwd"           : "{{env `QA_ROOT_PASSWD`}}",
    "packer_vcenter_host"      : "{{env `PACKER_VCENTER_HOST`}}",
    "packer_vcenter_username"  : "{{env `PACKER_VCENTER_USERNAME`}}",
    "packer_vcenter_password"  : "{{env `PACKER_VCENTER_PASSWORD`}}",
    "packer_vcenter_dc"        : "{{env `PACKER_VCENTER_DC`}}",
    "packer_vcenter_cluster"   : "{{env `PACKER_VCENTER_CLUSTER`}}",
    "packer_vcenter_datastore" : "{{env `PACKER_VCENTER_DATASTORE`}}",
    "packer_vcenter_folder"    : "{{env `PACKER_VCENTER_FOLDER`}}",
    "packer_vcenter_net"       : "{{env `PACKER_VCENTER_NET`}}",
    "packer_vcenter_insecure"  : "{{env `PACKER_VCENTER_INSECURE`}}",
    "packer_sha"               : "{{env `PACKER_SHA`}}",
    "packer_source_dir"        : "{{env `PACKER_VM_SRC_DIR`}}",
    "packer_output_dir"        : "{{env `PACKER_VM_OUT_DIR`}}"
  },

  "builders": [
    {
      "name"                   : "{{user `template_name`}}-{{user `provisioner`}}-{{user `template_config`}}",
      "vm_name"                : "packer-{{build_name}}",
      "type"                   : "vmware-vmx",
      "source_path"            : "{{user `packer_source_dir`}}/output-{{user `template_name`}}-{{user `provisioner`}}-base/packer-{{user `template_name`}}-{{user `provisioner`}}-base.vmx",
      "output_directory"       : "{{user `packer_output_dir`}}/output-{{build_name}}",

      "headless"               : "{{user `headless`}}",

      "ssh_username"           : "{{user `ssh_username`}}",
      "ssh_password"           : "{{user `ssh_password`}}",
      "ssh_port"               : 22,
      "ssh_wait_timeout"       : "10000s",
      "ssh_pty"                : "true",

      "shutdown_command"       : "{{user `shutdown_command`}}",

      "vmx_data"               : {
        "annotation"           : "Packer build: {{user `template_name`}}-{{user `version`}} built {{isotime}} SHA: {{user `packer_sha`}}"
      }
    }
  ],

  "provisioners": [
    {
      "type"                   : "file",
      "source"                 : "{{user `project_root`}}/scripts/osx/support/set_kcpassword.py",
      "destination"            : "/private/tmp/set_kcpassword.py"
    },

    {
      "type"                   : "shell",
      "execute_command"        : "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}",
      "environment_vars"       : [
        "INSTALL_XCODE_CLI_TOOLS={{user `install_xcode_cli_tools`}}",
        "PASSWORD={{user `ssh_password`}}",
        "USERNAME={{user `ssh_username`}}"
      ],
      "scripts"                : [
        "{{user `project_root`}}/scripts/osx/xcode-cli-tools.sh",
        "{{user `project_root`}}/scripts/osx/system-update.sh",
        "{{user `project_root`}}/scripts/osx/pooler.sh",
        "{{user `project_root`}}/scripts/osx/cleanup.sh",
        "{{user `project_root`}}/scripts/osx/shrink.sh"
      ]
    }
  ],

  "post-processors"            : [
    {
      "type"                   : "vsphere",
      "host"                   : "{{user `packer_vcenter_host`}}",
      "username"               : "{{user `packer_vcenter_username`}}",
      "password"               : "{{user `packer_vcenter_password`}}",
      "datacenter"             : "{{user `packer_vcenter_dc`}}",
      "cluster"                : "{{user `packer_vcenter_cluster`}}",
      "datastore"              : "{{user `packer_vcenter_datastore`}}",
      "vm_folder"              : "{{user `packer_vcenter_folder`}}",
      "vm_name"                : "{{user `template_name`}}-{{user `version`}}",
      "vm_network"             : "{{user `packer_vcenter_net`}}",
      "insecure"               : "{{user `packer_vcenter_insecure`}}",
      "overwrite"              : "true"
    }
  ]
}
